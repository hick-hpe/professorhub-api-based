{% extends 'planner/base.html' %}
{% load static %}

{% block title %}Disciplinas - Avaliações{% endblock %}

{% block titlenavbar %}
Disciplinas
{% endblock %}

{% block content %}
<div class="container my-2">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'disciplinas' %}">Disciplinas</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ disciplina.nome }}</li>
        </ol>
    </nav>
    <form class="mb-3">
        <div class="d-flex gap-3 flex-wrap align-items-center">
            <input type="email" class="form-control flex-grow-1" id="exampleInputEmail1" aria-describedby="emailHelp"
                placeholder="Pesquisar avaliações">

            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                <i class="bi bi-plus-lg"></i> Adicionar
            </button>
        </div>
    </form>

    <div class="abas-disciplinas">
        <div class="aba">
            <a href="{% url 'disciplina_planos' disciplina.id %}" class="nav-link">
                <span class="d-none d-sm-inline">Plano de Aula</span>
                <span class="d-inline d-sm-none">Planos</span>
            </a>
        </div>
        <div class="aba">
            <a href="{% url 'disciplina_tarefas' disciplina.id %}" class="nav-link">Tarefas</a>
        </div>
        <div class="aba active">
            <a href="{% url 'disciplina_avaliacoes' disciplina.id %}" class="nav-link">Avaliações</a>
        </div>
        <div class="aba">
            <a href="{% url 'disciplina_ementas' disciplina.id %}" class="nav-link">Ementas</a>
        </div>
        <div class="aba">
            <a href="{% url 'disciplina_objetivos' disciplina.id %}" class="nav-link">Objetivos</a>
        </div>
        <div class="aba">
            <a href="{% url 'disciplina_configuracoes' disciplina.id %}" class="nav-link">Configurações</a>
        </div>
    </div>

    <div class="container-table">
        <div class="table-responsive mt-3 shadow-sm rounded">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="table-primary text-center">
                    <tr>
                        <th scope="col" class="text-start ps-3">Identificador</th>
                        <th scope="col" class="text-center">Etapa</th>
                        <th scope="col" class="text-center">Data</th>
                        <th scope="col" class="text-center">Status</th>
                        <th scope="col" class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for avaliacao in avaliacoes %}
                    <tr>
                        <!-- Identificador -->
                        <td class="text-start ps-3">{{ avaliacao.identificador }}</td>
        
                        <!-- Etapa -->
                        <td class="text-center">{{ avaliacao.etapa|default:"—" }}</td>
        
                        <!-- Data -->
                        <td class="text-center">{{ avaliacao.data|date:'d/m/Y' }}</td>
        
                        <!-- Status -->
                        <td class="text-center">
                            {% if avaliacao.get_status_display == 'Não planejada' %}
                                <span class="badge bg-secondary">{{ avaliacao.get_status_display }}</span>
                            {% elif avaliacao.get_status_display == 'Planejada' %}
                                <span class="badge bg-primary">{{ avaliacao.get_status_display }}</span>
                            {% elif avaliacao.get_status_display == 'Em elaboração' %}
                                <span class="badge bg-warning text-dark">{{ avaliacao.get_status_display }}</span>
                            {% elif avaliacao.get_status_display == 'Elaborada' %}
                                <span class="badge bg-info text-dark">{{ avaliacao.get_status_display }}</span>
                            {% elif avaliacao.get_status_display == 'Aplicada' %}
                                <span class="badge bg-success">{{ avaliacao.get_status_display }}</span>
                            {% elif avaliacao.get_status_display == 'Corrigida' %}
                                <span class="badge bg-dark">{{ avaliacao.get_status_display }}</span>
                            {% elif avaliacao.get_status_display == 'Agendada' %}
                                <span class="badge bg-light text-dark border">{{ avaliacao.get_status_display }}</span>
                            {% endif %}
                        </td>
        
                        <!-- Ações -->
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button 
                                    class="btn btn-outline-warning btnEditarAvaliacao"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalEditarAvaliacao"
                                    data-id="{{ avaliacao.id }}"
                                    data-identificador="{{ avaliacao.identificador }}"
                                    data-disciplina="{{ avaliacao.disciplina.id }}"
                                    data-etapa="{{ avaliacao.etapa }}"
                                    data-tipo="{{ avaliacao.tipo }}"
                                    data-data="{{ avaliacao.data|date:'Y-m-d' }}"
                                    data-status="{{ avaliacao.status }}"
                                    title="Editar avaliação">
                                    <i class="bi bi-pencil"></i>
                                </button>
        
                                <button 
                                    class="btn btn-outline-danger btnExcluirAvaliacao"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalExcluirAvaliacao"
                                    data-id="{{ avaliacao.id }}"
                                    data-identificador="{{ avaliacao.identificador }}"
                                    title="Excluir avaliação">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="bi bi-clipboard-x"></i><br>
                            Nenhuma avaliação encontrada.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if tarefas.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page-tarefas={{ tarefas.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo; Anterior</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo; Anterior</span>
            </li>
            {% endif %}

            {% for num in tarefas.paginator.page_range %}
            {% if num == tarefas.number %}
            <li class="page-item active" aria-current="page">
                <span class="page-link">{{ num }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?page-tarefas={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if tarefas.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page-tarefas={{ tarefas.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">Próximo &raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Próximo &raquo;</span>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- adicionar -->
 <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                        Adicionar Avaliação
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'disciplina_avaliacoes' disciplina.id %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="disciplina" value="{{ disciplina.id }}">

                        <div class="mb-3">
                            <label for="identificador">Identificador</label><br>
                            <input type="text" class="form-control" id="identificador" name="identificador" required>
                        </div>

                        <div class="mb-3">
                            <label for="tipo_avaliacao">Tipo</label><br>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value selected disabled>Selecione o tipo</option>
                                <option value="avaliacao">Avaliação</option>
                                <option value="trabalho">Trabalho</option>
                                <option value="prova">Prova</option>
                                <option value="recuperacao">Recuperação</option>
                                <option value="seminario">Seminário</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="data">Data de aplicação</label><br>
                            <input type="date" class="form-control" id="data" name="data" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<!-- editar -->
<div class="modal fade" id="modalEditarAvaliacao" tabindex="-1" aria-labelledby="modalEditarAvaliacaoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarAvaliacaoLabel">
                    Editar Avaliação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarAvaliacao" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="disciplina" id="disciplina_edit" value="{{ disciplina.id }}">

                    <div class="mb-3">
                        <label for="identificador">Identificador</label><br>
                        <input type="text" class="form-control" id="identificador_edit" name="identificador"
                            required>
                    </div>

                    <div class="mb-3">
                        <label for="plano_aula">Plano de aula</label><br>
                        <select class="form-select" name="plano_aula" id="plano_aula_edit" required>
                            <option value selected disabled>Selecione o plano de aula</option>
                            {% for p in planos %}
                            <option value="{{ p.id }}">{{ p.titulo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="etapa">Etapa</label><br>
                        <input type="text" class="form-control" id="etapa_edit" name="etapa">
                    </div>

                    <div class="mb-3">
                        <label for="tipo_avaliacao">Tipo</label><br>
                        <select class="form-select" id="tipo_edit" name="tipo" required>
                            <option value selected disabled>Selecione o tipo</option>
                            <option value="avaliacao">Avaliação</option>
                            <option value="trabalho">Trabalho</option>
                            <option value="prova">Prova</option>
                            <option value="recuperacao">Recuperação</option>
                            <option value="seminario">Seminário</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="status">Status</label><br>
                        <select class="form-select" id="status_edit" name="status" required>
                            <option value selected disabled>Selecione o status</option>
                            <option value="nao_planejada">Não planejada</option>
                            <option value="planejada">Planejada</option>
                            <option value="em_elaboracao">Em elaboração</option>
                            <option value="elaborada">Elaborada</option>
                            <option value="aplicada">Aplicada</option>
                            <option value="corrigida">Corrigida</option>
                            <option value="agendada">Agendada</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="data">Data de aplicação</label><br>
                        <input type="date" class="form-control" id="data_edit" name="data" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Salvar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- modal excluir -->
<div class="modal fade" id="modalExcluirAvaliacao" tabindex="-1" aria-labelledby="modalExcluirAvaliacaoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalExcluirAvaliacaoLabel">Excluir plano</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formExcluirAvaliacao" action="" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    Deseja excluir a avaliação <strong id="nomeAvaliacaoExcluir"></strong>??
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/disciplina_detail_avaliacoes.js' %}"></script>
{% endblock %}
