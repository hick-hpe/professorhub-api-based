{% extends 'planner/base.html' %}
{% load static %}

{% block title %}Avaliações{% endblock %}

{% block titlenavbar %}
Avaliações
{% endblock %}

{% block content %}
<div class="container mt-3">
    <form class="mb-3">
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <input type="text" class="form-control flex-grow-1" id="pesquisarAvaliacoes" aria-describedby="emailHelp"
                placeholder="Pesquisar Avaliações">

            <select class="form-select" id="status_filter" name="status" style="width: 200px;">
                <option value="">Todas</option>
                <option value="agendada">Agendada</option>
                <option value="aplicada">Aplicada</option>
                <option value="corrigida">Corrigida</option>
                <option value="elaborada">Elaborada</option>
                <option value="em_elaboracao">Em elaboração</option>
                <option value="nao_planejada">Não planejada</option>
                <option value="planejada">Planejada</option>
            </select>

            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                <i class="bi bi-plus-lg"></i> Adicionar Avaliação
            </button>
        </div>
    </form>

    <div class="table-responsive mt-3 shadow-sm rounded">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-primary text-center align-middle">
                <tr>
                    <th scope="col" class="text-start ps-3">Identificador</th>
                    <th scope="col" class="text-start">Etapa</th>
                    <th scope="col">Data</th>
                    <th scope="col">Status</th>
                    <th scope="col">Ações</th>
                </tr>
            </thead>
            <tbody id="tbodyAvaliacoes" class="align-middle">
                {% for avaliacao in avaliacoes %}
                <tr>
                    <td class="text-start ps-3">{{ avaliacao.identificador }}</td>
                    <td class="text-start">{{ avaliacao.etapa|default:'—' }}</td>
                    <td class="text-center">{{ avaliacao.data|date:'d/m/Y' }}</td>
                    <td class="text-center">
                        {% if avaliacao.get_status_display == 'Não planejada' %}
                            <span class="badge bg-secondary">{{ avaliacao.get_status_display }}</span>
                        {% elif avaliacao.get_status_display == 'Planejada' %}
                            <span class="badge bg-primary">{{ avaliacao.get_status_display }}</span>
                        {% elif avaliacao.get_status_display == 'Em elaboração' %}
                            <span class="badge bg-warning text-dark">{{ avaliacao.get_status_display }}</span>
                        {% elif avaliacao.get_status_display == 'Elaborada' %}
                            <span class="badge bg-info text-dark">{{ avaliacao.get_status_display }}</span>
                        {% elif avaliacao.get_status_display == 'Aplicada' %}
                            <span class="badge bg-success">{{ avaliacao.get_status_display }}</span>
                        {% elif avaliacao.get_status_display == 'Corrigida' %}
                            <span class="badge bg-dark">{{ avaliacao.get_status_display }}</span>
                        {% elif avaliacao.get_status_display == 'Agendada' %}
                            <span class="badge bg-light text-dark border">{{ avaliacao.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button 
                                class="btn btn-outline-warning"
                                data-bs-toggle="modal"
                                data-bs-target="#modal_edit"
                                id="btn_edit_{{ avaliacao.id }}"
                                data-id="{{ avaliacao.id }}"
                                data-identificador="{{ avaliacao.identificador }}"
                                data-disciplina="{{ avaliacao.disciplina.id }}"
                                data-plano-aula="{{ avaliacao.plano_aula.id }}"
                                data-tipo="{{ avaliacao.tipo }}"
                                data-etapa="{{ avaliacao.etapa }}"
                                data-data="{{ avaliacao.data|date:'Y-m-d' }}"
                                data-status="{{ avaliacao.status }}"
                                title="Editar avaliação">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button 
                                class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#modal_delete"
                                data-id="{{ avaliacao.id }}"
                                title="Excluir avaliação">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-journal-x"></i><br>
                        Nenhuma avaliação cadastrada
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    

    <!-- adicionar -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                        Adicionar Avaliação
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'avaliacoes' %}" method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="identificador">Identificador</label><br>
                            <input type="text" class="form-control" id="identificador" name="identificador" required>
                        </div>

                        <div class="mb-3">
                            <label for="disciplina">Disciplina</label><br>
                            <select class="form-select" name="disciplina" id="disciplina" required>
                                <option value selected disabled>Selecione a disciplina</option>
                                {% for disciplina in disciplinas %}
                                <option value="{{ disciplina.pk }}">{{ disciplina.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tipo_avaliacao">Tipo</label><br>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value selected disabled>Selecione o tipo</option>
                                <option value="avaliacao">Avaliação</option>
                                <option value="trabalho">Trabalho</option>
                                <option value="prova">Prova</option>
                                <option value="recuperacao">Recuperação</option>
                                <option value="seminario">Seminário</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="data">Data de aplicação</label><br>
                            <input type="date" class="form-control" id="data" name="data" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- editar -->
    <div class="modal fade" id="modal_edit" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                        Editar Avaliação
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEdit" method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="identificador">Identificador</label><br>
                            <input type="text" class="form-control" id="identificador_edit" name="identificador"
                                required>
                        </div>

                        <div class="mb-3">
                            <label for="disciplina">Disciplina</label><br>
                            <select class="form-select" name="disciplina" id="disciplina_edit" required>
                                <option value selected disabled>Selecione a disciplina</option>
                                {% for disciplina in disciplinas %}
                                <option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="plano_aula">Plano de aula</label><br>
                            <select class="form-select" name="plano_aula" id="plano_aula_edit" required>
                                <option value selected disabled>Selecione o plano de aula</option>
                                {% for p in planos %}
                                <option value="{{ p.id }}">{{ p.titulo }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="etapa">Etapa</label><br>
                            <input type="text" class="form-control" id="etapa_edit" name="etapa">
                        </div>

                        <div class="mb-3">
                            <label for="tipo_avaliacao">Tipo</label><br>
                            <select class="form-select" id="tipo_edit" name="tipo" required>
                                <option value selected disabled>Selecione o tipo</option>
                                <option value="avaliacao">Avaliação</option>
                                <option value="trabalho">Trabalho</option>
                                <option value="prova">Prova</option>
                                <option value="recuperacao">Recuperação</option>
                                <option value="seminario">Seminário</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="status">Status</label><br>
                            <select class="form-select" id="status_edit" name="status" required>
                                <option value selected disabled>Selecione o status</option>
                                <option value="nao_planejada">Não planejada</option>
                                <option value="planejada">Planejada</option>
                                <option value="em_elaboracao">Em elaboração</option>
                                <option value="elaborada">Elaborada</option>
                                <option value="aplicada">Aplicada</option>
                                <option value="corrigida">Corrigida</option>
                                <option value="agendada">Agendada</option>
                            </select>
                        </div>


                        <div class="mb-3">
                            <label for="data">Data de aplicação</label><br>
                            <input type="date" class="form-control" id="data_edit" name="data" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- delete -->
    <div class="modal fade" id="modal_delete" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Excluir avaliação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Tem certeza que deseja excluir esta avaliação?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="confirm-excluir" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Excluir</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/avaliacoes.js' %}"></script>
{% endblock %}
