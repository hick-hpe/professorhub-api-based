{% extends 'planner/base.html' %}
{% load static %}

{% block title %}Tarefas{% endblock %}

{% block titlenavbar %}
Tarefas
{% endblock %}

{% block content %}
<div class="container mt-3">
    <form class="mb-3">
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <input type="text" class="form-control flex-grow-1"
                id="pesquisarTarefas"
                aria-describedby="emailHelp" placeholder="Pesquisar tarefas">

            <select class="form-select" id="status_filter" style="width: 200px;">
                <option value="">Todos os status</option>
                <option value="concluida">Concluída</option>
                <option value="criada">Criada</option>
                <option value="em_andamento">Em andamento</option>
                <option value="pendente">Pendente</option>
            </select>

            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#exampleModal">
                <i class="bi bi-plus-lg"></i> Adicionar Tarefa
            </button>
        </div>
    </form>

    <div class="table-responsive mt-4 shadow-sm rounded">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-primary text-center align-middle">
                <tr>
                    <th scope="col" class="text-start ps-3">Nome</th>
                    <th scope="col" class="d-none d-sm-table-cell text-start">Descrição</th>
                    <th scope="col" class="d-none d-sm-table-cell text-start">Disciplina</th>
                    <th scope="col">Prazo</th>
                    <th scope="col">Status</th>
                    <th scope="col">Ações</th>
                </tr>
            </thead>
            <tbody id="tbodyTarefas" class="align-middle">
                {% for tarefa in tarefas %}
                <tr>
                    <!-- Nome -->
                    <td class="text-start fw-semibold ps-3">{{ tarefa.nome }}</td>
    
                    <!-- Descrição -->
                    <td class="d-none d-sm-table-cell text-start" title="{{ tarefa.descricao }}">
                        {{ tarefa.descricao|truncatechars:20 }}
                    </td>
    
                    <!-- Disciplina -->
                    <td class="d-none d-sm-table-cell text-start">{{ tarefa.disciplina }}</td>
    
                    <!-- Prazo -->
                    <td class="text-center">{{ tarefa.prazo|date:'d/m/Y' }}</td>
    
                    <!-- Status -->
                    <td class="text-center">
                        {% if tarefa.get_status_display == 'Criada' %}
                        <span class="badge bg-info text-dark">{{ tarefa.get_status_display }}</span>
                        {% elif tarefa.get_status_display == 'Em andamento' %}
                        <span class="badge bg-warning text-dark">{{ tarefa.get_status_display }}</span>
                        {% elif tarefa.get_status_display == 'Pendente' %}
                        <span class="badge bg-danger">{{ tarefa.get_status_display }}</span>
                        {% elif tarefa.get_status_display == 'Concluída' %}
                        <span class="badge bg-success">{{ tarefa.get_status_display }}</span>
                        {% endif %}
                    </td>
    
                    <!-- Ações -->
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <!-- Botão Editar -->
                            <button
                                class="btn btn-outline-warning"
                                data-bs-toggle="modal"
                                data-bs-target="#modal_edit"
                                id="btn_edit_{{ tarefa.id }}"
                                data-id="{{ tarefa.id }}"
                                data-nome="{{ tarefa.nome }}"
                                data-descricao="{{ tarefa.descricao }}"
                                data-disciplina="{{ tarefa.disciplina.id }}"
                                data-plano-aula="{{ tarefa.plano_aula.id }}"
                                data-prazo="{{ tarefa.prazo|date:'Y-m-d' }}"
                                data-status="{{ tarefa.status }}"
                                title="Editar tarefa"
                            >
                                <i class="bi bi-pencil"></i>
                            </button>
    
                            <!-- Botão Excluir -->
                            <button
                                class="btn btn-outline-danger"
                                data-id="{{ tarefa.id }}"
                                data-nome="{{ tarefa.nome }}"
                                data-bs-toggle="modal"
                                data-bs-target="#modal_delete"
                                title="Excluir tarefa"
                            >
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
    
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-clipboard-x"></i><br>
                        Nenhuma tarefa cadastrada
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    

    <!-- adicionar -->
    <div class="modal fade" id="exampleModal" tabindex="-1"
        aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                        Adicionar Tarefa
                    </h5>
                    <button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'tarefas' %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="disciplina">Disciplina</label><br>
                            <select class="form-select" name="disciplina" id="disciplina" required>
                                <option value selected disabled>Selecione a disciplina</option>
                                {% for disciplina in disciplinas %}
                                    <option value="{{ disciplina.id }}" data-nome="{{ disciplina.nome }}">{{ disciplina.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="nome">Nome da tarefa</label><br>
                            <input type="text" class="form-control"
                                id="nome"
                                name="nome" required>
                        </div>

                        <div class="mb-3">
                            <label for="descricao">Descrição</label><br>
                            <textarea class="form-control" id="descricao"
                                name="descricao" rows="5"
                                style="resize: none;" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="prazo">Data de
                                entrega</label><br>
                            <input type="date" class="form-control"
                                id="prazo"
                                name="prazo" required>
                        </div>

                        <button class="btn btn-primary w-100">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- editar -->
    <div class="modal fade" id="modal_edit" tabindex="-1"
        aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                        Editar Tarefa
                    </h5>
                    <button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEdit" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="id" id="data_id" value="">

                        <div class="mb-3">
                            <label for="disciplina">Disciplina</label><br>
                            <select class="form-select" name="disciplina" id="disciplina_edit" required>
                                <option value selected disabled>Selecione a disciplina</option>
                                {% for disciplina in disciplinas %}
                                    <option value="{{ disciplina.id }}" data-nome="{{ disciplina.nome }}">{{ disciplina.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="plano_aula">Plano de aula</label><br>
                            <select class="form-select" name="plano_aula" id="plano_aula_edit" required>
                                <option value selected disabled>Selecione o plano de aula</option>
                                {% for p in planos %}
                                    <option value="{{ p.id }}">{{ p.titulo }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="nome">Nome da tarefa</label><br>
                            <input type="text" class="form-control"
                                id="nome_edit"
                                name="nome" required>
                        </div>

                        <div class="mb-3">
                            <label for="descricao">Descrição</label><br>
                            <textarea class="form-control" id="descricao_edit"
                                name="descricao" rows="5"
                                style="resize: none;" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="prazo">Data de
                                entrega</label><br>
                            <input type="date" class="form-control"
                                id="prazo_edit"
                                name="prazo" required>
                        </div>

                        <div class="mb-3">
                            <label for="status">Status</label><br>
                            <select class="form-select" name="status" id="status_edit" required>
                                <option value selected disabled>Selecione o plano de aula</option>
                                <option value="criada">Criada</option>
                                <option value="em_andamento">Em andamento</option>
                                <option value="concluida">Concluída</option>
                            </select>
                        </div>

                        <button class="btn btn-primary w-100">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<!-- delete -->
 <div class="modal fade" id="modal_delete" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Excluir tarefa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Tem certeza que deseja excluir esta tarefa?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="confirm-excluir" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Excluir</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/tarefas.js' %}"></script>
{% endblock %}
